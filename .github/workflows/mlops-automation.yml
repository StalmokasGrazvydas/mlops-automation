name: 4.0 - MLOps automation

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/mlops-automation.yml"
      - "environment/**"
      - "components/**"
      - "pipelines/**"
      - "inference/**"

# Needed so the workflow can push images to GitHub Container Registry
permissions:
  contents: read
  packages: write

jobs:
  azure-pipeline:
    name: Azure ML pipeline
    runs-on: ubuntu-latest

    env:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
      AZURE_WORKSPACE: ${{ secrets.AZURE_WORKSPACE }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure ML CLI
        run: |
          az account set --subscription $AZURE_SUBSCRIPTION_ID
          az extension add -n ml -y
          az configure --defaults workspace=$AZURE_WORKSPACE group=$AZURE_RESOURCE_GROUP

      - name: Azure -- Create compute
        run: |
          az ml compute show --name cli-mlops-machine || az ml compute create --file ./environment/compute.yaml

      # Ensure the environments used by the components exist (version 0.1.1)
      - name: Azure -- Register environments
        run: |
          echo "Checking aml-preprocessing-cli:0.1.1"
          az ml environment show --name aml-preprocessing-cli --version 0.1.1 || az ml environment create --file ./environment/preprocessing.yaml

          echo "Checking aml-training-cli:0.1.1"
          az ml environment show --name aml-training-cli --version 0.1.1 || az ml environment create --file ./environment/training.yaml

      - name: Azure -- Register components
        run: |
          az ml component create --file ./components/dataprep/dataprep.yaml
          az ml component create --file ./components/split/component.yml
          az ml component create --file ./components/training/training.yaml

      - name: Azure -- Pipeline in Azure
        run: |
          az ml job create \
            --file ./pipelines/animals-classification.yaml \
            --stream \
            --set name=animals-classification-${{ github.sha }}-${{ github.run_id }}

      - name: Azure -- Stop compute
        if: always()
        continue-on-error: true
        run: |
          az ml compute stop --name cli-mlops-machine || echo "Compute already stopped"

  download:
    name: Download latest model + upload inference
    needs: azure-pipeline
    runs-on: ubuntu-24.04

    env:
      AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
      AZURE_WORKSPACE: ${{ secrets.AZURE_WORKSPACE }}
      AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure -- Download Model
        uses: azure/CLI@v2.1.0
        with:
          azcliversion: 2.64.0
          inlineScript: |
            # Workaround for msal NormalizedResponse cache bug
            rm -f ~/.azure/msal_http_cache.bin || true

            az extension add --name ml -y
            az configure --defaults group=$AZURE_RESOURCE_GROUP workspace=$AZURE_WORKSPACE location=$AZURE_LOCATION    

            echo "Finding latest version of registered model 'animal-classification'..."
            VERSION=$(az ml model list -n animal-classification --query "[0].version" -o tsv)
            echo "Latest version: $VERSION"

            mkdir -p inference/animal-classification
            az ml model download \
              --name animal-classification \
              --version $VERSION \
              --download-path inference/animal-classification

      - name: Docker -- Upload API code from Inference
        uses: actions/upload-artifact@v4.3.3
        with:
          name: docker-config
          path: inference

  container:
    name: Build & push Docker image
    needs: download
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download docker-config artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-config
          path: .

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Docker build & push
        run: |
          # Make owner lowercase for GHCR
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME=ghcr.io/$OWNER_LC/animals-classification

          echo "Using image name: $IMAGE_NAME:latest"

          docker build -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:latest

